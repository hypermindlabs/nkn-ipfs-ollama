<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>NKN Client — LLM Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <meta name="theme-color" content="#000" />
  <!-- NKN SDK -->
  <script src="https://unpkg.com/nkn-sdk@1.3.6/dist/nkn.min.js"></script>

  <!-- Import map (kept as requested) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
    }
  }
  </script>

  <!-- QR, Markdown, and Syntax Highlighting -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/tomorrow-night-blue.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap');

    :root {
      --bg: #000;
      --panel: #0a0a0a;
      --line: #141414;
      --fg: #fff;
      --muted: #bfbfbf;
      --accent: #fff;
      --pad: 12px;
      --radius: 14px;
      --shadow: 0 12px 30px rgba(0, 0, 0, .45);
    }

    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: "Instrument Sans", sans-serif;
      touch-action: manipulation;
      user-select: none;
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      grid-template-columns: 260px 1fr;
      grid-template-areas: "top top" "left main";
      height: 100%
    }

    header {
      max-height: 400px;
      grid-area: top;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-flow: wrap;
      gap: 10px;
      padding: 10px var(--pad);
      background: #000;
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--line)
    }

    .brand {
      font-weight: 700;
      letter-spacing: .3px
    }

    .spacer {
      flex: 1
    }

    .topbar-select {
      appearance: none;
      background: #000;
      border: 1px solid #2a2a2a;
      color: var(--fg);
      padding: 8px 10px;
      border-radius: 10px;
      line-height: 1;
      height: 38px;
      max-width: calc(100vw - 154px);
    }

    .chip {
      padding: 6px 10px;
      border: 1px solid #2a2a2a;
      border-radius: 999px;
      color: #eaeaea;
      background: #0a0a0a
    }

    .chiprow {
      display: flex;
      flex-flow: row;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .gear {
      display: flex;
      flex-flow: row;
      justify-content: center;
      min-width: 34px;
      min-height: 34px;
      cursor: pointer;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 10px 10px;
      font-size: 14px;
      line-height: 1;
      background: #0a0a0a;
      color: white;
    }

    .gear:active {
      transform: scale(1.02)
    }

    .col-left {
      grid-area: left;
      border-right: 1px solid #141414;
      background: #050505;
      display: flex;
      flex-direction: column;
      min-width: 0
    }

    .left-head {
      padding: 10px var(--pad);
      border-bottom: 1px solid #141414;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .sessions {
      flex: 1;
      overflow: auto;
      padding: 8px
    }

    .session {
      position: relative;
      padding: 10px;
      border: 1px solid #1a1a1a;
      border-radius: 12px;
      margin-bottom: 8px;
      background: #0a0a0a;
      cursor: pointer
    }

    .session.active {
      border-color: #fff
    }

    .session .title {
      font-weight: 600;
      padding-right: 28px
    }

    .session small {
      color: #cfcfcf;
      opacity: .8
    }

    .session .del {
      position: absolute;
      top: 0px;
      right: 0px;
      height: 32px;
      width: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      cursor: pointer;
      border: unset;
      background: transparent;
    }

    .session .del:hover {
      background: #111
    }

    .col-main {
      position: relative;
      box-sizing: border-box;
      grid-area: main;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      min-width: 0
    }

    .sysedit {
      padding: 12px;
      border-bottom: 1px solid #141414;
      background: #050505;
      box-sizing: border-box;
      height: auto;
      width: 100%;
      line-height: 1;
      box-shadow: 0px 0px 20px 10px black;
      z-index: 2;
      position: absolute;
      top: 0px;

    }

    .sysedit label {
      display: block;
      font-size: 12px;
      color: #cfcfcf;
      margin-bottom: 6px;
    }

    .sysinput {
      width: 100%;
      min-height: 64px;
      resize: vertical;
      background: #000;
      border: 1px solid #2a2a2a;
      color: #fff5;
      border-radius: 12px;
      padding: 10px
    }

    .sysinput:focus {
      outline: none;
      border-color: #fff;
      color: #fff
    }

    .chat {
      position: relative;
      display: block;
      height: 100%;
      flex: 1;
      overflow: auto;
      padding: 16px;
      max-height: calc(100vh - 180px);
      scroll-behavior: smooth
    }

    .msg {
      max-width: 900px;
      margin: 0 auto 14px auto;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #1a1a1a
    }

    .user {
      background: #0a0a0a
    }

    .assistant {
      background: #0a0a0a;
      border-color: #2a2a2a
    }

    .meta {
      display: flex;
      gap: 10px;
      align-items: center;
      color: #bfbfbf;
      font-size: 12px;
      margin-bottom: 6px
    }

    .content {
      word-wrap: break-word
    }

    .content p {
      margin: .5em 0
    }

    .content img {
      max-width: 100%;
      border-radius: 8px
    }

    .content code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background: #0b0b0b;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      padding: .2em .35em
    }

    .content pre {
      background: #0b0b0b;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      overflow: auto
    }

    .content pre code {
      background: transparent;
      border: none;
      padding: 0
    }

    .content blockquote {
      border-left: 3px solid #2a2a2a;
      margin: 8px 0;
      padding: 6px 10px;
      color: #cfd8dc;
      background: #071018;
      border-radius: 8px
    }

    .content ul,
    .content ol {
      padding-left: 1.4em
    }

    .composer {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid #141414;
      background: #050505
    }

    .input {
      flex: 1;
      resize: none;
      height: 40px;
      border: unset;
      background: #000;
      color: var(--fg);
      border-radius: 12px;
      padding: 12px
    }


    #systemToggleBtn{
      color:#2a2a2a;
      border-color:#2a2a2a;
    }

    .btnSq {
      aspect-ratio: 1 / 1;
    }

    .btn {
      background-color: black;
      border: 1px solid #fff;
      color: #fff;
      padding: 8px 8px;
      line-height: 1;
      display: flex;
      flex-flow: column;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer
    }

    .btn:hover {
      background-color: white;
      border: 1px solid #fff;
      color: #000;
      padding: 8px 8px;
      line-height: 1;
      display: flex;
      flex-flow: column;
      justify-content: center;
      border-radius: 12px;
      cursor: pointer
    }

    .btn:hover>svg path {
      stroke: black;
    }

    .btn:active {
      transform: translateY(1px)
    }

    @keyframes dotdotdot {
      0% {
        content: '.'
      }

      33% {
        content: '..'
      }

      66% {
        content: '...'
      }

      100% {
        content: ''
      }

    }

    .dot {
      animation: dotdotdot 1s linear infinite;
    }

    @keyframes bump {
      0% {
        transform: translateX(0px)
      }

      40% {
        transform: translateX(-3px)rotate(-5deg)
      }

      60% {
        transform: translateX(3px)rotate(5deg)
      }

      100% {
        transform: translateX(0px)rotate(0deg)
      }

    }

    .sendButton {
      background: transparent;
      border: unset;
      cursor: pointer;
    }

    .sendButton:hover {
      animation: bump 0.3s ease-in-out;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .muted {
      color: #cfcfcf;
      opacity: .8
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .modal {
      width: min(560px, 92vw);
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px
    }

    .modal h3 {
      margin: .2rem 0 .8rem 0
    }

    .modal>.row {
      display: flex;
      justify-content: flex-start;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px
    }

    .text {
      background: #000;
      border: 1px solid #2a2a2a;
      color: #fff;
      padding: 10px;
      border-radius: 10px
    }

    .num {
      background: #000;
      border: 1px solid #2a2a2a;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      width: 120px
    }

    .chkrow {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px
    }

    .modal .row {
      justify-content: flex-end;
      margin-top: 10px
    }

    /* ── Connection status dot in header ───────────────────────────────────── */
    .conn-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #2a2a2a;
      display: inline-block;
    }

    .conn-blue {
      background: #3b82f6;
    }

    /* connecting / reconnecting */
    .conn-green {
      background: #22c55e;
    }

    /* connected */
    .conn-red {
      background: #ef4444;
    }

    /* error / disconnected */

    .hide {
      display: none !important;
    }

    /* helper to hide model select until ready */
    #toggleSidebar {
      display: none;
    }

    .backdropModal {
      height: 100vh;
      width: 100vw;
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: -1;
    }

    @media (max-width: 900px) {
      #toggleSidebar {
        display: flex;
      }

      .app {
        grid-template-columns: 1fr;
        grid-template-areas: "top" "main"
      }

      .col-left {
        display: flex;
        position: absolute;
        width: 50%;
        z-index: 10;
        left: -50%;
        top: 54px;
        bottom: 0px;
      }

      #backdrop {
        height: 100vh;
        position: absolute;
        bottom: 0px;
        width: 100vw;
        left: -100%;
        backdrop-filter: blur(10px);
        z-index: -1;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <button class="gear" id="toggleSidebar" onclick="toggleSidebar()">
        <!-- (icon unchanged) -->
        <svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M11 5V19M6 8H8M6 11H8M6 14H8M6.2 19H17.8C18.9201 19 19.4802 19 19.908 18.782C20.2843 18.5903 20.5903 18.2843 20.782 17.908C21 17.4802 21 16.9201 21 15.8V8.2C21 7.0799 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V15.8C3 16.9201 3 17.4802 3.21799 17.908C3.40973 18.2843 3.71569 18.5903 4.09202 18.782C4.51984 19 5.07989 19 6.2 19Z"
            stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>

      <!-- NEW: connection status (dot + label). The model select will be injected next to this. -->
      <div id="statusRow" class="row">
        <span id="connDot" class="conn-dot conn-blue" aria-hidden="true"></span>
        <span id="connText" class="muted">Connecting…</span>
      </div>

      <!-- The select stays in DOM; we will move it next to #statusRow and hide it until models are ready -->
      <select id="modelSelect" class="topbar-select" title="Available models" disabled>
        <option style="text-align:center;">Loading Models</option>
      </select>

      <button id="settingsBtn" class="gear btnSq" aria-label="Settings">
        <!-- (icon unchanged) -->
        <svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M12 3L14.0357 8.16153C14.2236 8.63799 14.3175 8.87622 14.4614 9.0771C14.5889 9.25516 14.7448 9.41106 14.9229 9.53859C15.1238 9.68245 15.362 9.77641 15.8385 9.96432L21 12L15.8385 14.0357C15.362 14.2236 15.1238 14.3175 14.9229 14.4614C14.7448 14.5889 14.5889 14.7448 14.4614 14.9229C14.3175 15.1238 14.2236 15.362 14.0357 15.8385L12 21L9.96432 15.8385C9.77641 15.362 9.68245 15.1238 9.53859 14.9229C9.41106 14.7448 9.25516 14.5889 9.0771 14.4614C8.87622 14.3175 8.63799 14.2236 8.16153 14.0357L3 12L8.16153 9.96432C8.63799 9.77641 8.87622 9.68245 9.0771 9.53859C9.25516 9.41106 9.41106 9.25516 9.53859 9.0771C9.68245 8.87622 9.77641 8.63799 9.96432 8.16153L12 3Z"
            stroke="#ffffff" stroke-width="2" stroke-linejoin="round" />
        </svg>
      </button>
    </header>

    <aside id="sidebar" class="col-left">
      <div class="left-head row">
        <div style="font-weight:600">Sessions</div>
        <div class="spacer"></div>
        <button id="newSessionBtn" class="btn btnSq"><svg width="16px" height="16px" viewBox="0 0 24 24" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path d="M6 12H18M12 6V18" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg></button>
      </div>
      <div id="sessions" class="sessions"></div>
      <div id="backdrop" class="backdrop" onclick="toggleSidebar()"></div>
    </aside>

    <main class="col-main">
      <div class="sysedit">
        <!-- Collapsed default: a button (you'll style it) -->
        <button id="systemToggleBtn" class="btn">System Message</button>

        <!-- Revealed editor -->
        <div id="systemEditorWrap" class="hide">
          <textarea id="systemMsg" class="sysinput"
            placeholder="(Optional) e.g. 'You are a concise assistant. Answer with short bullets.'"></textarea>

          <div class="row" id="systemActions" style="margin-top:8px">

            <button id="sysGenBtn" class="btn" type="button">Generate</button>
            <button id="sysSaveBtn" class="btn" type="button">Save</button>
            <button id="systemToggleBtnInside" class="btn">Close</button>

          </div>
        </div>

      </div>

      <div id="chat" class="chat"></div>

      <div class="composer">
        <textarea id="prompt" class="input" placeholder="Type a message… (Shift+Enter = newline)"></textarea>
        <button id="sendBtn" class="sendButton"><svg width="16px" height="16px" viewBox="0 0 24 24" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M16.6582 9.28638C18.098 10.1862 18.8178 10.6361 19.0647 11.2122C19.2803 11.7152 19.2803 12.2847 19.0647 12.7878C18.8178 13.3638 18.098 13.8137 16.6582 14.7136L9.896 18.94C8.29805 19.9387 7.49907 20.4381 6.83973 20.385C6.26501 20.3388 5.73818 20.0469 5.3944 19.584C5 19.053 5 18.1108 5 16.2264V7.77357C5 5.88919 5 4.94701 5.3944 4.41598C5.73818 3.9531 6.26501 3.66111 6.83973 3.6149C7.49907 3.5619 8.29805 4.06126 9.896 5.05998L16.6582 9.28638Z"
              stroke="#ffffff" stroke-width="2" stroke-linejoin="round" />
          </svg></button>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="chiprow">
        <div class="chip" id="hubChip">hub: —</div>
        <div class="chip" id="meChip">me: —</div>
      </div>
      <h3>Settings</h3>
      <div class="field">
        <label>Hub address (signaling server) <span class="muted">(identifier.publicKeyHex64)</span></label>
        <input id="hubInput" class="text" placeholder="e.g. hub.0123abcd…64hex" spellcheck="false" />
      </div>
      <div class="row" style="gap:20px;flex-wrap:wrap;justify-content: flex-start;">
        <div class="field"><label>Temperature</label><input id="optTemperature" class="num" type="number" step="0.01"
            min="0" max="2" /></div>
        <div class="field"><label>Top-p</label><input id="optTopP" class="num" type="number" step="0.01" min="0"
            max="1" /></div>
        <div class="field"><label>Seed</label><input id="optSeed" class="num" type="number" step="1" /></div>
        <div class="field"><label>Context (num_ctx)</label><input id="optNumCtx" class="num" type="number" step="1"
            min="128" /></div>
      </div>
      <div class="field">
        <div class="chkrow">
          <input id="optStream" type="checkbox" />
          <label for="optStream">Stream responses by default</label>
        </div>
        <div class="muted" style="margin-top:2px">Uncheck to request non-streaming results.</div>
      </div>
      <div class="row">
        <div class="spacer"></div>
        <button id="closeModal" class="btn" style="background:#0a0a0a;border-color:#2a2a2a">Close</button>
        <button id="saveSettings" class="btn">Save</button>
      </div>
    </div>
    <div class="backdropModal" onclick="closeSettings()"></div>
  </div>

  <!-- Copy-to-clipboard helper for code blocks -->
  <script>
    (() => {
      const style = document.createElement('style');
      style.textContent = `
    pre { position: relative; }
    .code-copy-btn {
      position: absolute; top: 8px; right: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid #2a2a2a;
      color: #eaeaea;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
    }
    .code-copy-btn:active { transform: translateY(1px); }
    .code-copy-btn.ok {
      border-color: #4caf50;
      color: #b2fab4;
    }
  `;
      document.head.appendChild(style);

      const hasSelection = () => {
        const sel = window.getSelection && window.getSelection();
        return sel && String(sel).length > 0;
      };
      const flash = (btn, msg = 'Copied!') => {
        const orig = btn.textContent;
        btn.textContent = msg;
        btn.classList.add('ok');
        setTimeout(() => {
          btn.textContent = orig;
          btn.classList.remove('ok');
        }, 1200);
      };
      const fallbackCopy = (text, btn) => {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { flash(btn, document.execCommand('copy') ? 'Copied!' : 'Failed'); }
        catch { flash(btn, 'Failed'); }
        finally { document.body.removeChild(ta); }
      };
      const doCopy = (codeEl, btn) => {
        const text = codeEl.textContent || '';
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(
            () => flash(btn, 'Copied!'),
            () => fallbackCopy(text, btn)
          );
        } else fallbackCopy(text, btn);
      };
      const attachButton = (codeEl) => {
        if (!codeEl || codeEl.dataset.copyAttached === '1') return;
        const pre = codeEl.closest('pre'); if (!pre) return;
        if (pre.querySelector('.code-copy-btn')) { codeEl.dataset.copyAttached = '1'; return; }
        const btn = document.createElement('button');
        btn.type = 'button'; btn.className = 'code-copy-btn'; btn.textContent = 'Copy';
        pre.appendChild(btn);
        btn.addEventListener('click', (e) => { e.stopPropagation(); doCopy(codeEl, btn); });
        pre.addEventListener('click', () => { if (!hasSelection()) doCopy(codeEl, btn); });
        codeEl.dataset.copyAttached = '1';
      };
      const scan = (root = document) => { root.querySelectorAll('pre > code').forEach(attachButton); };
      const mo = new MutationObserver((muts) => {
        for (const m of muts) m.addedNodes && m.addedNodes.forEach((n) => {
          if (n.nodeType !== 1) return;
          if (n.matches && n.matches('pre > code')) attachButton(n); else scan(n);
        });
      });
      mo.observe(document.documentElement, { childList: true, subtree: true });
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => scan()); else scan();
    })();
  </script>

  <script>
    // ─────────── Utils & storage
    const $ = s => document.querySelector(s);
    const el = id => document.getElementById(id);
    const short = s => s ? (s.slice(0, 7) + '…' + s.slice(-6)) : '—';
    const isNknAddr = s => /^[A-Za-z0-9_-]+\.[0-9a-f]{64}$/.test((s || '').trim());
    const debounce = (fn, ms = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    // Markdown + code highlighting setup
    marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });
    function mdToHtml(s) { try { return marked.parse(String(s || '')); } catch { return String(s || ''); } }
    function highlightIn(node) { try { node.querySelectorAll('pre code').forEach(block => { try { hljs.highlightElement(block); } catch { } }); } catch { } }

    const STORAGE = {
      SESS: 'CLIENT_SESSIONS_V2',
      SETTINGS: 'CLIENT_SETTINGS_V2',
      SEED: 'CLIENT_SEED_HEX_V2',
      HUB: 'CLIENT_HUB_ADDR_V2',
      LEGACY_SEED: 'PEERBALLS_SEED_HEX',
      LEGACY_HUB: 'PEERBALLS_HUB_ADDR',
      LAST_MODEL: 'CLIENT_LAST_SELECTED_MODEL_V2'
    };
    function getCurrentModel() {
      const s = getSession();
      // Prefer the session’s model; then the visible select; then the remembered one.
      return (s && s.model) || (el('modelSelect') && el('modelSelect').value) || getSavedModel() || '';
    }

    // --- System Message helpers/state ---
    const SYSTEM_GEN_PROMPT =
      "You are a system prompt generator. Given the user's description, return ONE compact, actionable system prompt that sets role, tone, constraints, and safety. Use imperative, second person. No examples unless essential.";

    const sysgenPending = new Set();   // track in-flight generation requests
    let isSysGenStreaming = false;    // NEW
    let sysgenCurrentId = null;       // NEW
    let sysgenAcc = "";                 // accumulating streamed text
    let sysgenPrevPlaceholder = "";     // to restore after finish/error

    function toggleSystemEditor(forceOpen) {
      const wrap = el('systemEditorWrap'); if (!wrap) return;
      const toggleOut = el('systemToggleBtn');          // outside button
      const toggleIn = el('systemToggleBtnInside');    // inside button (shown only when open)

      const show = forceOpen ?? wrap.classList.contains('hide'); // true = open editor

      if (show) {
        wrap.classList.remove('hide');      // show editor
        if (toggleOut) toggleOut.classList.add('hide');     // hide outside button
        if (toggleIn) toggleIn.classList.remove('hide');   // show inside button
      } else {
        wrap.classList.add('hide');         // hide editor
        if (toggleOut) toggleOut.classList.remove('hide');  // show outside button
        if (toggleIn) toggleIn.classList.add('hide');      // hide inside button
      }
    }

    function setSysGenBusy(isBusy) {
      const b = el('sysGenBtn'); if (!b) return;
      b.disabled = !!isBusy;
      b.textContent = isBusy ? 'Generating…' : 'Generate';
    }

    function setConn(color, label) {
      const dot = el('connDot'), text = el('connText');
      if (!dot || !text) return;

      dot.classList.remove('conn-red', 'conn-green', 'conn-blue');
      dot.classList.add(color === 'green' ? 'conn-green' : color === 'red' ? 'conn-red' : 'conn-blue');

      if (label && label.trim()) {
        text.classList.remove('hide');        // show label
        text.textContent = label;
      } else {
        text.textContent = '';                // clear label
        text.classList.add('hide');           // collapse immediately (no width)
      }
    }

    function showModelDropdown(show) {
      const sel = el('modelSelect');
      if (!sel) return;
      sel.classList[show ? 'remove' : 'add']('hide');
      sel.disabled = !show;
    }

    function loadJSON(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch { return fallback; }
    }
    function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    const toHex = buf => Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
    function getOrCreateSeed() {
      let hex = localStorage.getItem(STORAGE.SEED) || localStorage.getItem(STORAGE.LEGACY_SEED);
      if (/^[0-9a-f]{64}$/.test(hex || '')) return hex;
      const r = new Uint8Array(32); crypto.getRandomValues(r); hex = toHex(r);
      localStorage.setItem(STORAGE.SEED, hex); return hex;
    }

    // Settings
    const settings = (() => {
      const defaultHub = localStorage.getItem(STORAGE.HUB) || localStorage.getItem(STORAGE.LEGACY_HUB) || '';
      return loadJSON(STORAGE.SETTINGS, {
        hub: defaultHub, temperature: 0.2, top_p: 0.9, seed: 0, num_ctx: 4096, stream: true
      });
    })();

    // --- URL param → hub (supports ?hub=… or #hub=… and aliases) ---
    function getUrlHubParam() {
      const tryRead = (sp) => sp.get('hub') || sp.get('nkn') || sp.get('signaling') || sp.get('signal');
      let v = '';
      try { v = tryRead(new URLSearchParams(location.search)) || ''; } catch { }
      if (!v && location.hash && location.hash.includes('=')) {
        try { v = tryRead(new URLSearchParams(location.hash.slice(1))) || ''; } catch { }
      }
      return (v || '').trim();
    }
    function applyHubFromUrl() {
      const h = getUrlHubParam();
      if (h && isNknAddr(h)) {
        settings.hub = h;
        saveJSON(STORAGE.SETTINGS, settings);
        localStorage.setItem(STORAGE.HUB, h);
        try {
          const url = new URL(location.href);
          ['hub', 'nkn', 'signaling', 'signal'].forEach(k => url.searchParams.delete(k));
          history.replaceState(null, '', url.toString());
        } catch { }
      }
    }

    function updateSettingsUI() {
      el('hubInput').value = settings.hub || '';
      el('optTemperature').value = settings.temperature;
      el('optTopP').value = settings.top_p;
      el('optSeed').value = settings.seed;
      el('optNumCtx').value = settings.num_ctx;
      el('optStream').checked = !!settings.stream;
    }
    function saveSettingsFromUI() {
      const prevHub = settings.hub;
      const hub = el('hubInput').value.trim();
      if (!isNknAddr(hub)) { alert('Invalid hub address'); return false; }
      settings.hub = hub;
      settings.temperature = parseFloat(el('optTemperature').value || '0') || 0;
      settings.top_p = parseFloat(el('optTopP').value || '1') || 1;
      settings.seed = parseInt(el('optSeed').value || '0', 10) || 0;
      settings.num_ctx = parseInt(el('optNumCtx').value || '4096', 10) || 4096;
      settings.stream = !!el('optStream').checked;
      saveJSON(STORAGE.SETTINGS, settings);
      localStorage.setItem(STORAGE.HUB, settings.hub);
      if (prevHub !== settings.hub) { location.reload(); return false; }
      const s = getSession(); if (s) sendSessionOpen(s, /*seed*/false);
      return true;
    }

    // Sessions
    let sessions = loadJSON(STORAGE.SESS, []);
    let activeSessionId = (sessions[0]?.id) || null;

    const getSavedModel = () => localStorage.getItem(STORAGE.LAST_MODEL) || (sessions[0]?.model || '');
    const setSavedModel = (m) => { if (m) localStorage.setItem(STORAGE.LAST_MODEL, m); };

    function newId(prefix = 'id') { return prefix + '-' + Math.random().toString(16).slice(2) + Date.now().toString(36); }
    function createSessionForModel(model) {
      const id = newId('sess');
      const s = { id, title: model, model, system: '', createdAt: Date.now(), messages: [] };
      sessions.unshift(s); activeSessionId = id; saveJSON(STORAGE.SESS, sessions);
      setSavedModel(model);
      renderSessions(); renderSystemEditor(); renderChat();
      sendSessionOpen(s, /*seed*/true);
    }
    function getSession(id = activeSessionId) { return sessions.find(x => x.id === id) || null; }
    function setActiveSession(id) {
      activeSessionId = id;
      const s = getSession();
      if (s && s.model) {
        setSavedModel(s.model);
        const sel = el('modelSelect');
        if (sel && Array.from(sel.options).some(o => o.value === s.model)) sel.value = s.model;
      }
      renderSessions(); renderSystemEditor(); renderChat();
      if (s) sendSessionOpen(s, /*seed*/true);
    }
    function appendMessage(sessId, role, content) {
      const s = getSession(sessId); if (!s) return; s.messages.push({ role, content, ts: Date.now() }); saveJSON(STORAGE.SESS, sessions);
    }
    function updateLastAssistantContent(sessId, content) {
      const s = getSession(sessId); if (!s) return;
      for (let i = s.messages.length - 1; i >= 0; i--) {
        if (s.messages[i].role === 'assistant') { s.messages[i].content = content; break; }
      }
      saveJSON(STORAGE.SESS, sessions);
    }
    function deleteSession(id) {
      const idx = sessions.findIndex(x => x.id === id);
      if (idx === -1) return;
      const sid = sessions[idx].id;
      sendSessionReset(sid);
      sessions.splice(idx, 1);
      saveJSON(STORAGE.SESS, sessions);
      if (activeSessionId === id) activeSessionId = sessions[0]?.id || null;
      if (sessions[0]?.model) setSavedModel(sessions[0].model);
      renderSessions(); renderSystemEditor(); renderChat();
      if (activeSessionId) { const s = getSession(); if (s) sendSessionOpen(s, /*seed*/true); }
    }

    function renderSessions() {
      const box = el('sessions'); box.innerHTML = '';
      sessions.forEach(s => {
        const div = document.createElement('div'); div.className = 'session' + (s.id === activeSessionId ? ' active' : '');
        div.onclick = () => setActiveSession(s.id);
        div.innerHTML = `
        <div class="title">${s.title || s.model || 'Session'}</div>
        <small>${s.model || ''} • ${new Date(s.createdAt).toLocaleString()}</small>
        <button class="del" title="Delete session" aria-label="Delete"><svg width="16px" height="16px" viewBox="0 0 24 24" style="transform:rotate(45deg);" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path d="M6 12H18M12 6V18" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg></button>
      `;
        const del = div.querySelector('.del');
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('Delete this session?')) deleteSession(s.id);
        });
        box.appendChild(div);
      });
    }

    // Markdown renderer for message body
    function messageHtml(role, content) { return mdToHtml(content || ''); }

    function renderSystemEditor() {
      const s = getSession();
      const ta = el('systemMsg');
      if (!s) {
        ta.value = '';
        ta.placeholder = '(Select or create a session to set a system prompt)';
        ta.disabled = true;
        return;
      }
      ta.disabled = false;
      ta.value = s.system || '';
      ta.placeholder = "(Optional) e.g. 'You are a concise assistant. Answer with short bullets.'";
    }

    function renderChat() {
      const s = getSession(); const box = el('chat'); box.innerHTML = '';
      if (!s) { box.innerHTML = `<div class="muted" style="text-align:center;margin-top:30px">Choose a model above to create a session.</div>`; return; }
      s.messages.forEach(m => {
        const w = document.createElement('div'); w.className = 'msg ' + (m.role === 'user' ? 'user' : 'assistant');
        const contentHtml = messageHtml(m.role, m.content);
        w.innerHTML = `<div class="meta">${m.role} • ${new Date(m.ts).toLocaleTimeString()}</div><div class="content">${contentHtml}</div>`;
        box.appendChild(w);
        highlightIn(w);
      });
      box.scrollTop = box.scrollHeight;
    }

    function addStreamingAssistantBubble() {
      const s = getSession(); if (!s) return;
      const w = document.createElement('div'); w.className = 'msg assistant'; w.dataset.stream = '1';
      w.innerHTML = `<div class="meta">assistant • streaming…</div><div class="content" id="streamContent"></div>`;
      el('chat').appendChild(w); el('chat').scrollTop = el('chat').scrollHeight;
    }
    function setStreamingContent(text) {
      const c = el('streamContent');
      if (c) {
        c.innerHTML = mdToHtml(text || '');
        highlightIn(c);
        el('chat').scrollTop = el('chat').scrollHeight;
      }
    }
    function finishStreamingBubble() {
      const c = el('streamContent'); if (c) { c.removeAttribute('id'); }
      const m = document.querySelector('.msg.assistant[data-stream="1"] .meta'); if (m) m.textContent = 'assistant • done';
      const w = document.querySelector('.msg.assistant[data-stream="1"]'); if (w) w.dataset.stream = '0';
    }

    // ─────────── NKN (robust MultiClient + your message contract)
    let client = null, myAddr = null; let HUB_ADDR = settings.hub || '';
    function updateChips() { el('hubChip').textContent = 'hub: ' + (HUB_ADDR ? short(HUB_ADDR) : '—'); el('meChip').textContent = 'me: ' + (myAddr ? short(myAddr) : '—'); }
    function trySend(addr, obj) { if (!client || !addr) return; try { client.send(addr, JSON.stringify(obj)); } catch { } }

    // Streaming (ordered)
    const streams = new Map();
    let currentStreamId = null;
    let pendingStreamId = null;
    let isStreaming = false;
    const cancelledStreams = new Set();

    function startStream(id, onChunk) { streams.set(id, { next: 1, lastAck: 0, buffer: new Map(), onChunk }); }
    function handleChunk(id, seq, data) {
      if (cancelledStreams.has(id)) return;
      const st = streams.get(id); if (!st) return; st.buffer.set(seq, data);
      if (!isStreaming && currentStreamId === null && pendingStreamId === id) { setStopMode(id); }
      while (st.buffer.has(st.next)) { const part = st.buffer.get(st.next); st.buffer.delete(st.next); st.onChunk(part); st.next++; }
      sendAck(id, st.next - 1);
    }
    function sendAck(id, upto) { const st = streams.get(id); if (!st || upto <= st.lastAck) return; st.lastAck = upto; trySend(HUB_ADDR, { event: 'llm.ack', id, upto }); }
    function endStream(id) { streams.delete(id); cancelledStreams.delete(id); if (currentStreamId === id) currentStreamId = null; if (pendingStreamId === id) pendingStreamId = null; }

    // Models
    let modelsLoaded = false;
    let modelRevealTimer = null;   // <— NEW
    let clearLabelTimer = null;      // NEW
    let allowModelsReveal = false;   // NEW (guard against any early reveals)
    function requestModelsList() { trySend(HUB_ADDR, { event: 'llm.request', api: 'list', stream: false }); }
    function ensureModels() {
      const backoff = [0, 500, 1500, 3000, 5000, 8000];
      backoff.forEach((ms) => setTimeout(() => { if (!modelsLoaded) { requestModelsList(); } }, ms));
    }
    function populateModels(models) {
      const sel = el('modelSelect'); sel.innerHTML = '';
      (models || []).forEach(m => {
        const name = m.model || m.name || '';
        if (!name) return;
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
      });
      modelsLoaded = (sel.options.length > 0);
      sel.disabled = !modelsLoaded;
      if (!modelsLoaded) { const opt = document.createElement('option'); opt.textContent = '— no models —'; sel.appendChild(opt); }
      const remembered = getSavedModel();
      if (remembered && Array.from(sel.options).some(o => o.value === remembered)) { sel.value = remembered; }
      sel.onchange = () => {
        const model = sel.value;
        if (model && modelsLoaded) { setSavedModel(model); createSessionForModel(model); }
      };

      showModelDropdown(true);  // <— NEW (keeps it visible when models land)
    }

    // Build history for seeding (exclude 'system'; it's sent separately)
    function buildHistoryForSession(sess) { return (sess?.messages || []).map(m => ({ role: m.role, content: m.content })); }

    // Session control → hub
    function currentOptions() { return { temperature: settings.temperature, top_p: settings.top_p, seed: settings.seed, num_ctx: settings.num_ctx }; }
    function sendSessionOpen(s, seed) {
      if (!s || !HUB_ADDR) return;
      const payload = {
        event: 'session.open',
        sid: s.id,
        model: s.model || undefined,
        system: (s.system || ''),
        options: currentOptions()
      };
      if (seed) { payload.history = buildHistoryForSession(s); payload.replace = true; }
      trySend(HUB_ADDR, payload);
    }
    function sendSessionReset(sid) { if (!sid || !HUB_ADDR) return; trySend(HUB_ADDR, { event: 'session.reset', sid }); }

    // EXACTLY follow the proven NKN connect pattern; identifier MUST be 'client'
    function connectNKN() {
      // Require hub set first (as in your original)
      if (!isNknAddr(HUB_ADDR)) { openSettings(); return; }
      updateChips();
      setConn('blue', 'Connecting…');

      client = new nkn.MultiClient({
        seed: getOrCreateSeed(),
        identifier: 'client',     // <—— address prefix YOU asked for
        numSubClients: 4,
        originalClient: true
      });

      client.onConnect(() => {
        setConn('green', 'Connected');          // show "Connected" immediately
        myAddr = client.addr; updateChips();
        setConn('green', '');
        trySend(HUB_ADDR, { event: 'announce' });

        // Clear prior timers on reconnects
        if (clearLabelTimer) clearTimeout(clearLabelTimer);
        if (modelRevealTimer) clearTimeout(modelRevealTimer);

        clearLabelTimer = setTimeout(() => {
          // 1) Remove label first (green dot only)

          // 2) Force a reflow so the label collapse is applied BEFORE we reveal the select
          const t = el('connText'); if (t) void t.offsetWidth;

          // 3) Next tick: reveal the select and request models
          modelRevealTimer = setTimeout(() => {
            const sel = el('modelSelect');
            if (sel) {
              sel.innerHTML = '<option>Loading Models</option>';
              sel.disabled = true;
              showModelDropdown(true);          // select appears only after label is gone
            }
            modelsLoaded = false;
            requestModelsList();
            ensureModels();
          }, 0);
        }, 10);

        const s = getSession();
        if (s) {
          setSavedModel(s.model || getSavedModel());
          sendSessionOpen(s, /*seed*/true);
        }
      });


      // EXACT dispatch style: funnel to onInbound, only process if src===HUB_ADDR
      client.on('message', onInbound);
      client.on('willreconnect', () => setConn('blue', 'Reconnecting…'));
      client.on('connectFailed', () => setConn('red', 'Connect failed'));
      client.on('close', () => setConn('red', 'Disconnected'));
      client.on('error', () => setConn('red', 'Error'));
      window.addEventListener('beforeunload', () => { try { client && client.close(); } catch { } });
    }



    // Inbound
    function onInbound(a, b) {
      let src, payload;
      if (a && typeof a === 'object' && (a.payload !== undefined || a.data !== undefined || a.src !== undefined)) {
        src = a.src || a.from || ''; payload = a.payload ?? a.data;
      } else { src = a; payload = b; }
      let body = null;
      try {
        if (payload instanceof Uint8Array) body = JSON.parse(new TextDecoder().decode(payload));
        else if (typeof payload === 'string') body = JSON.parse(payload);
        else body = payload;
      } catch { return; }
      if (!body || src !== HUB_ADDR) return;

      const ev = body.event;

      // --- intercept one-off system-prompt generation replies ---
      if (ev === 'llm.result' && sysgenPending.has(body.id)) {
        const out = extractFull(body.data) || '';
        const ta = el('systemMsg');
        ta.readOnly = false;
        ta.placeholder = sysgenPrevPlaceholder;
        ta.value = out;

        setSysGenBusy(false);
        sysgenPending.delete(body.id);
        isSysGenStreaming = false;
        sysgenCurrentId = null;
        sysgenAcc = "";
        sysgenPrevPlaceholder = "";
        return
      }
      if (ev === 'llm.error' && sysgenPending.has(body.id)) {
        const ta = el('systemMsg');
        ta.readOnly = false;
        ta.placeholder = sysgenPrevPlaceholder; // restore
        // leave ta.value as-is (user input) or empty if you cleared it
        setSysGenBusy(false);
        isSysGenStreaming = false;
        sysgenPending.delete(body.id);
        sysgenCurrentId = null;
        sysgenAcc = "";
        sysgenPrevPlaceholder = "";
        alert('[System Prompt Generator] ' + (body.message || 'Error'));
        return;
      }

      if (ev === 'session.ready' || ev === 'session.info' || ev === 'ctrl.info') { return; }
      if (ev === 'ctrl.error') { console.warn('[ctrl.error]', body); return; }

      if (ev === 'llm.models' && body.data && body.data.models) { populateModels(body.data.models); return; }
      if (ev === 'llm.result' && body.data && body.data.models) { populateModels(body.data.models); return; }

      if (ev === 'llm.start') {
        const { id, stream } = body;
        if (sysgenPending.has(id)) {
          // stream into the textarea instead of a chat bubble
          isSysGenStreaming = true;
          sysgenCurrentId = id;

          startStream(id, (part) => {
            const t = extractDelta(part);
            if (t) {
              const ta = el('systemMsg');
              sysgenAcc += t;
              ta.placeholder = sysgenAcc;   // ← type into placeholder
            }
          });
          return; // do not create assistant chat bubble for sysgen
        }

        // (keep your existing chat-streaming code below for normal chats)
        if (stream) {
          pendingStreamId = id;
          addStreamingAssistantBubble();
          const sess = getSession(); if (!sess) return;
          sess.messages.push({ role: 'assistant', content: '', ts: Date.now() }); saveJSON(STORAGE.SESS, sessions);
          let acc = '';
          startStream(id, (part) => {
            const text = extractDelta(part);
            if (text) { acc += text; setStreamingContent(acc); updateLastAssistantContent(sess.id, acc); }
          });
        }
        return;
      }
      if (ev === 'llm.chunk') { handleChunk(body.id, body.seq, body.data); return; }
      if (ev === 'llm.done') {
        if (sysgenCurrentId && body.id === sysgenCurrentId) {
          sendAck(body.id, body.last_seq);
          endStream(body.id);
          const ta = el('systemMsg');
          ta.value = (sysgenAcc || "").trim();   // commit the generated prompt
          ta.placeholder = sysgenPrevPlaceholder; // restore original placeholder
          ta.readOnly = false;

          isSysGenStreaming = false;
          setSysGenBusy(false);
          sysgenPending.delete(body.id);
          sysgenCurrentId = null;
          sysgenAcc = "";
          sysgenPrevPlaceholder = "";
          return;
        }


        // (keep your existing chat 'done' handling below)
        finishStreamingBubble(); sendAck(body.id, body.last_seq); endStream(body.id);
        setSendMode(); return;
      }
      if (ev === 'llm.result') {
        const sess = getSession(); if (!sess) return;
        const text = extractFull(body.data);
        appendMessage(sess.id, 'assistant', text);
        renderChat();
        return;
      }
      if (ev === 'llm.error') {
        const sess = getSession(); if (!sess) return;
        appendMessage(sess.id, 'assistant', '[error] ' + body.message);
        renderChat();
        setSendMode();
        return;
      }
    }

    function extractDelta(part) {
      if (part?.message?.content) return part.message.content;
      if (typeof part?.response === 'string') return part.response;
      return '';
    }
    function extractFull(obj) {
      if (obj?.message?.content) return obj.message.content;
      if (typeof obj?.response === 'string') return obj.response;
      try { return JSON.stringify(obj); } catch { return String(obj); }
    }

    // Compose & send (DELTA MODE)
    function sendPrompt() {
      const s = getSession(); if (!s) { alert('Choose a model first.'); return; }
      const text = el('prompt').value; if (!text.trim()) return;

      appendMessage(s.id, 'user', text.trim()); renderChat(); el('prompt').value = '';

      const reqId = newId('req');
      const doStream = !!settings.stream;

      trySend(HUB_ADDR, {
        event: 'llm.request',
        id: reqId,
        api: 'chat',
        sid: s.id,
        delta: text.trim(),
        stream: doStream,
        kwargs: { options: currentOptions() }
      });
    }

    // Stop button behavior
    function setStopMode(id) {
      const btn = el('sendBtn');
      currentStreamId = id;
      isStreaming = true;
      btn.textContent = '⏹';
      btn.onclick = stopGeneration;
    }
    const playSign = `<svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M16.6582 9.28638C18.098 10.1862 18.8178 10.6361 19.0647 11.2122C19.2803 11.7152 19.2803 12.2847 19.0647 12.7878C18.8178 13.3638 18.098 13.8137 16.6582 14.7136L9.896 18.94C8.29805 19.9387 7.49907 20.4381 6.83973 20.385C6.26501 20.3388 5.73818 20.0469 5.3944 19.584C5 19.053 5 18.1108 5 16.2264V7.77357C5 5.88919 5 4.94701 5.3944 4.41598C5.73818 3.9531 6.26501 3.66111 6.83973 3.6149C7.49907 3.5619 8.29805 4.06126 9.896 5.05998L16.6582 9.28638Z" stroke="#ffffff" stroke-width="2" stroke-linejoin="round"/>
</svg>`;
    const stopSign = `<svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect x="4" y="4" width="16" height="16" rx="2" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

    function setSendMode() {
      const btn = el('sendBtn');
      isStreaming = false;
      pendingStreamId = null;
      currentStreamId = null;
      btn.innerHTML = playSign;
      btn.onclick = sendPrompt;
    }
    function stopGeneration() {
      if (!currentStreamId || !HUB_ADDR) { setSendMode(); return; }
      cancelledStreams.add(currentStreamId);
      trySend(HUB_ADDR, { event: 'llm.cancel', id: currentStreamId });
      setSendMode();
    }

    // System editor → persist locally and push to hub
    el('systemMsg').addEventListener('input', debounce(() => {
      if (isSysGenStreaming) return; // avoid pushing while generator streams
      const s = getSession(); if (!s) return;
      s.system = el('systemMsg').value;
      saveJSON(STORAGE.SESS, sessions);
      sendSessionOpen(s, /*seed*/false);
    }, 250));

    // Settings modal
    function openSettings() { updateSettingsUI(); el('overlay').style.display = 'flex'; }
    function closeSettings() { el('overlay').style.display = 'none'; }

    // Sidebar Toggle Mobile
    function toggleSidebar() {
      const elx = document.getElementById('sidebar');
      const elxb = document.getElementById('backdrop');
      if (!elx) return;
      const curLeft = getComputedStyle(elx).left.trim();
      elx.style.left = (curLeft === '0px' || curLeft === '0%') ? '-50%' : '0%';
      elxb.style.left = (curLeft === '0px' || curLeft === '0%') ? '-100%' : '0%';
    }

    // Boot
    function boot() {
      (() => {
        const row = el('statusRow'), sel = el('modelSelect');
        if (row && sel && sel.parentElement !== row) row.appendChild(sel);
        showModelDropdown(false); // hide until models list arrives
      })();

      // System Message toggle + actions
      el('systemToggleBtn').onclick = () => toggleSystemEditor();  // show/hide editor
      el('systemToggleBtnInside').onclick = () => toggleSystemEditor();  // show/hide editor

      el('sysGenBtn').onclick = () => {
        if (!HUB_ADDR) { openSettings(); return; }

        const input = (el('systemMsg').value || '').trim();
        if (!input) { alert('Type what you want your system prompt to do, then click Generate.'); return; }

        const model = getCurrentModel();
        if (!model) { alert('Choose a model first, then try Generate again.'); return; }

        const genId = newId('sysgen');
        sysgenPending.add(genId);
        setSysGenBusy(true);

        // Prep textarea for placeholder streaming
        const ta = el('systemMsg');
        sysgenAcc = "";
        sysgenPrevPlaceholder = ta.placeholder || "";
        ta.value = "";               // keep empty so placeholder is visible
        ta.placeholder = "";         // will be filled as tokens arrive
        ta.readOnly = true;          // avoid user edits during streaming

        trySend(HUB_ADDR, {
          event: 'llm.request',
          id: genId,
          api: 'chat',
          model,
          stream: true,
          messages: [
            { role: 'system', content: SYSTEM_GEN_PROMPT },
            { role: 'user', content: input }
          ],
          kwargs: { options: currentOptions() },
          aux: 'sysgen'
        });
      };

      el('sysSaveBtn').onclick = () => {
        const s = getSession();
        if (!s) { alert('Create/select a session first.'); return; }
        s.system = el('systemMsg').value || '';
        saveJSON(STORAGE.SESS, sessions);
        sendSessionOpen(s, /*seed*/false);
        // Optional: collapse after save
        // toggleSystemEditor(false);
      };

      // Apply hub from URL before anything else that depends on it (RESTORED FEATURE)
      applyHubFromUrl();

      renderSessions(); renderSystemEditor(); renderChat(); updateSettingsUI();

      // Ensure HUB_ADDR reflects (possibly updated) settings.hub
      HUB_ADDR = settings.hub || '';
      updateChips();

      el('sendBtn').onclick = sendPrompt;
      el('prompt').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); } });
      el('settingsBtn').onclick = openSettings; el('closeModal').onclick = closeSettings;
      el('saveSettings').onclick = () => { if (saveSettingsFromUI()) { closeSettings(); } };
      el('newSessionBtn').onclick = () => {
        const sel = el('modelSelect'); const model = sel.value || sel.options[0]?.value;
        if (!model || sel.disabled) { alert('No models yet. Set hub and ensure it’s running.'); return; }
        createSessionForModel(model);
      };

      if (activeSessionId) setActiveSession(activeSessionId);
      connectNKN(); // uses MultiClient with identifier: 'client'
    }
    boot();
  </script>
</body>

</html>
